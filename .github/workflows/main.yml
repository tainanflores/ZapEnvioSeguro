name: Build and Release Installer

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  deploy-to-github-releases:
    runs-on: windows-latest
    steps:
    
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Write release version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo Version: $VERSION
          echo "VERSION=$VERSION" >> $GITHUB_ENV
        shell: bash
      
      - name: Install .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Publish Application
        run: dotnet publish ZapEnvioSeguro.csproj -c Release -o publish -r win-x64 --self-contained true

      - name: Create Velopack Release
        run: |
          dotnet tool install -g vpk
          vpk download github --repoUrl https://github.com/tainanflores/ZapEnvioSeguro --token ${{ secrets.GITHUB_TOKEN }}
          vpk pack -u ZapEnvioSeguro -v ${{ env.VERSION }} -p publish
          vpk upload github --repoUrl https://github.com/tainanflores/ZapEnvioSeguro --publish --releaseName "ZapEnvioSeguro ${{ env.VERSION }}" --tag v${{ env.VERSION }} --token ${{ secrets.GITHUB_TOKEN }}
        
      - name: Checkout Updates Repository
        uses: actions/checkout@v4
        with:
          repository: tainanflores/ZapEnvioSeguroUpdates
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy Releases to Updates Repository
        run: |
          rm -rf *
          cp -r Releases/* ./
          git add .
          git commit -m "Release version ${{ env.VERSION }}"
          git tag -a v${{ env.VERSION }} -m "Release version ${{ env.VERSION }}"
          git push origin main --tags
        shell: bash
